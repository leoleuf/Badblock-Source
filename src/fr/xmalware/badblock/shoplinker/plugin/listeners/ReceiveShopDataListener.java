package fr.xmalware.badblock.shoplinker.plugin.listeners;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;

import com.google.gson.Gson;

import fr.badblock.rabbitconnector.RabbitConnector;
import fr.badblock.rabbitconnector.RabbitListener;
import fr.xmalware.badblock.shoplinker.api.ShopData;
import fr.xmalware.badblock.shoplinker.api.ShopLinkerSettings;
import fr.xmalware.badblock.shoplinker.plugin.ShopLinker;
import fr.xmalware.badblock.shoplinker.plugin.permissions.AbstractPermissions;
import lombok.Data;
import lombok.EqualsAndHashCode;
import lombok.Getter;

@Data @EqualsAndHashCode(callSuper=false)
public class ReceiveShopDataListener extends RabbitListener {

	@Getter public static Gson gson	= new Gson();
	
	public ReceiveShopDataListener(String queueName) {
		super(RabbitConnector.getInstance().getService("default"), ShopLinkerSettings.QUEUE_PREFIX + queueName, ShopLinkerSettings.DEBUG, ShopLinkerSettings.LISTENER_TYPE);
	}

	@Override
	public void onPacketReceiving(String body) {
		if (body == null) return;
		ShopData shopData = gson.fromJson(body, ShopData.class);
		if (shopData == null) return;
		// exécution
		AbstractPermissions permissionsManager = AbstractPermissions.getPermissions();
		if (permissionsManager.isInGroup(shopData.getPlayerName(), shopData.getRankName())) {
			ShopLinker.getConsole().sendMessage(ChatColor.GOLD + "[ShopLinker] " + ChatColor.RESET + shopData.getPlayerName() + " is already in the group named as " + shopData.getRankName());
			return;
		}
		permissionsManager.addGroup(shopData.getPlayerName(), shopData.getRankName());
		ShopLinker.getConsole().sendMessage(ChatColor.GOLD + "[ShopLinker] " + ChatColor.RESET + shopData.getPlayerName() + " is now in the group " + shopData.getRankName());
		Bukkit.broadcastMessage(ShopLinker.getMessage().replace("%0", shopData.getPlayerName()).replace("%1", shopData.getRankName()));
	}

}
